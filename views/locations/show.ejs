<%- include("../partials/header"); %>

<div class="container" style="max-width: 1200px;">
    <!-- Back Button -->
    <a href="/locations" class="btn btn-camp-secondary mb-4">
        <i class="bi bi-arrow-left me-2"></i>Back to All Locations
    </a>
    
    <!-- Image Section -->
    <div class="show-image-container">
        <img 
            src="<%= location.image %>" 
            alt="<%= location.name %>"
            onerror="this.src='https://images.unsplash.com/photo-1504280390367-361c6d9f38f4?w=800&q=80'"
        >
    </div>
    
    <!-- Details Section -->
    <div class="show-details">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h1 class="h2 mb-2 location-title" data-original="<%= location.name %>" style="font-family: var(--font-display);">
                    <%= location.name %>
                </h1>
                <% if(location.author && location.author.username) { %>
                    <p class="text-muted mb-0">
                        <i class="bi bi-person-circle me-1"></i>
                        Submitted by <strong><%= location.author.username %></strong>
                    </p>
                <% } %>
            </div>
            
            <!-- Translate All Button -->
            <button 
                class="btn-translate-all" 
                onclick="translateAll()"
                data-translated="false"
                title="Translate all content to English"
            >
                <i class="bi bi-translate"></i>
                <span class="translate-text">Translate to English</span>
            </button>
        </div>
        
        <% if(location.description) { %>
            <div class="mt-4">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>About this place</h5>
                </div>
                <p class="mb-0 location-description" data-original="<%= location.description %>"><%= location.description %></p>
            </div>
        <% } %>
        
        <div class="show-meta">
            <%
                // Get creation date - use ObjectId timestamp as fallback for old documents
                var createdDate = location.createdAt || location._id.getTimestamp();
                var updatedDate = location.updatedAt;
                
                // Check if the location was updated (updatedAt is significantly different from createdAt)
                var wasUpdated = updatedDate && updatedDate.getTime() - createdDate.getTime() > 60000; // More than 1 minute difference
            %>
            <% if(wasUpdated) { %>
                <i class="bi bi-pencil me-1"></i>
                Updated <%= moment(updatedDate).fromNow() %>
                <span class="text-muted ms-2" style="font-size: 0.8rem;">
                    (Created <%= moment(createdDate).fromNow() %>)
                </span>
            <% } else { %>
                <i class="bi bi-clock me-1"></i>
                Added <%= moment(createdDate).fromNow() %>
            <% } %>
        </div>
        
        <!-- Owner Actions -->
        <% if(currentUser && location.author && location.author.id.equals(currentUser._id)) { %>
            <div class="mt-4 pt-4 border-top d-flex gap-2 flex-wrap">
                <a class="btn btn-camp-warning" href="/locations/<%= location._id %>/edit">
                    <i class="bi bi-pencil me-1"></i>Edit Location
                </a>
                <form class="delete-form" action="/locations/<%= location._id %>?_method=DELETE" method="POST">
                    <button class="btn btn-camp-danger" type="submit">
                        <i class="bi bi-trash me-1"></i>Delete Location
                    </button>
                </form>
            </div>
        <% } %>
    </div>
    
    <!-- Comments Section (Below Image) -->
    <div class="comments-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">
                <i class="bi bi-chat-dots me-2"></i>Comments (<%= location.comments ? location.comments.length : 0 %>)
            </h5>
            <% if(currentUser) { %>
                <a class="btn btn-camp-primary btn-sm" href="/locations/<%= location._id %>/comments/new">
                    <i class="bi bi-plus me-1"></i>Add Comment
                </a>
            <% } %>
        </div>
        
        <% if(!location.comments || location.comments.length === 0) { %>
            <div class="text-center py-4">
                <i class="bi bi-chat-square-text" style="font-size: 2rem; color: var(--color-light-tertiary);"></i>
                <p class="text-muted mt-2 mb-0">No comments yet. Be the first to share your thoughts!</p>
            </div>
        <% } else { %>
            <% location.comments.forEach(function(comment) { %>
                <div class="comment-card">
                    <div class="d-flex justify-content-between align-items-start">
                        <span class="comment-author">
                            <i class="bi bi-person-circle me-1"></i>
                            <%= comment.author.username %>
                        </span>
                        <span class="comment-time">
                            <%
                                var commentDate = comment._id.getTimestamp();
                            %>
                            <%= moment(commentDate).fromNow() %>
                        </span>
                    </div>
                    <p class="comment-text" data-original="<%= comment.text %>"><%= comment.text %></p>
                    
                    <% if(currentUser && comment.author && comment.author.id.equals(currentUser._id)) { %>
                        <div class="comment-actions">
                            <a class="btn btn-sm btn-outline-secondary" href="/locations/<%= location._id %>/comments/<%= comment._id %>/edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form action="/locations/<%= location._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST" class="delete-form">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </div>
                    <% } %>
                </div>
            <% }); %>
        <% } %>
    </div>
</div>

<!-- Translate Button Styles -->
<style>
    .btn-translate-all {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-translate-all:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-translate-all:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-translate-all.translated {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
    }
    
    .btn-translate-all.translated:hover {
        box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
    }
    
    .btn-translate-all .spinner-border {
        width: 14px;
        height: 14px;
        border-width: 2px;
    }
    
    .translating {
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }
</style>

<!-- Translation Script -->
<script>
    const MAX_CHUNK_SIZE = 450; // MyMemory has 500 char limit, leave buffer
    
    // Language detection based on character patterns and common words
    function detectLanguage(text) {
        // Check for common non-Latin scripts
        if (/[\u3040-\u30ff\u31f0-\u31ff]/.test(text)) return 'ja'; // Japanese
        if (/[\u4e00-\u9fff]/.test(text)) return 'zh-CN'; // Chinese
        if (/[\uac00-\ud7af]/.test(text)) return 'ko'; // Korean
        if (/[\u0600-\u06ff]/.test(text)) return 'ar'; // Arabic
        if (/[\u0400-\u04ff]/.test(text)) return 'ru'; // Russian/Cyrillic
        if (/[\u0900-\u097f]/.test(text)) return 'hi'; // Hindi
        if (/[\u0e00-\u0e7f]/.test(text)) return 'th'; // Thai
        
        const lowerText = text.toLowerCase();
        
        // Spanish - expanded patterns including accented characters and common words/endings
        if (/[áéíóúüñ¿¡]/.test(text)) return 'es'; // Spanish accents
        if (/\b(el|la|los|las|es|está|están|para|por|con|una?|del|al|muy|más|menos|como|pero|porque|cuando|donde|qué|quién|cómo|hermoso|hermosa|bonito|bonita|lindo|linda|paisaje|increíble|asombroso|asombrosa|mira|mirando|lugar|lugares|visitando|viaje|viajes)\b/i.test(lowerText)) return 'es';
        if (/\b(se\s+\w+|me\s+\w+|te\s+\w+|nos\s+\w+)\b/.test(lowerText)) return 'es'; // Spanish reflexive pronouns
        if (/\b\w+(ción|sión|mente|ando|endo|ado|ido|oso|osa)\b/.test(lowerText)) return 'es'; // Spanish word endings
        
        // French
        if (/[àâäæçéèêëîïôœùûü]/.test(text)) return 'fr';
        if (/\b(le|la|les|de|du|des|est|sont|pour|avec|une?|très|plus|moins|comme|mais|parce|quand|où|qui|comment|beau|belle|magnifique|incroyable)\b/i.test(lowerText)) return 'fr';
        
        // German
        if (/[äöüß]/.test(text)) return 'de';
        if (/\b(der|die|das|ist|sind|für|mit|und|ein|eine|sehr|mehr|weniger|wie|aber|weil|wenn|wo|wer|schön|wunderbar)\b/i.test(lowerText)) return 'de';
        
        // Italian
        if (/[àèéìòù]/.test(text)) return 'it';
        if (/\b(il|lo|la|gli|le|di|da|che|per|con|una?|molto|più|meno|come|ma|perché|quando|dove|chi|bello|bella|bellissimo|incredibile)\b/i.test(lowerText)) return 'it';
        
        // Portuguese
        if (/[ãõàáâéêíóôú]/.test(text)) return 'pt';
        if (/\b(o|a|os|as|é|são|para|com|uma?|muito|mais|menos|como|mas|porque|quando|onde|quem|lindo|linda|maravilhoso|incrível)\b/i.test(lowerText)) return 'pt';
        
        // Dutch
        if (/\b(het|de|een|van|voor|met|zijn|zeer|meer|minder|zoals|maar|omdat|wanneer|waar|wie|mooi|prachtig|ongelooflijk)\b/i.test(lowerText)) return 'nl';
        
        return 'en'; // Default to English
    }
    
    // Split text into chunks at sentence boundaries
    function splitIntoChunks(text, maxSize) {
        if (text.length <= maxSize) {
            return [text];
        }
        
        const chunks = [];
        let remaining = text;
        
        while (remaining.length > 0) {
            if (remaining.length <= maxSize) {
                chunks.push(remaining);
                break;
            }
            
            // Try to split at sentence boundary (. ! ? followed by space)
            let splitIndex = -1;
            const searchArea = remaining.substring(0, maxSize);
            
            // Look for sentence endings
            const lastPeriod = searchArea.lastIndexOf('. ');
            const lastExclaim = searchArea.lastIndexOf('! ');
            const lastQuestion = searchArea.lastIndexOf('? ');
            const lastSemicolon = searchArea.lastIndexOf('; ');
            const lastComma = searchArea.lastIndexOf(', ');
            
            splitIndex = Math.max(lastPeriod, lastExclaim, lastQuestion);
            
            // If no sentence boundary, try semicolon or comma
            if (splitIndex === -1 || splitIndex < maxSize * 0.3) {
                splitIndex = Math.max(lastSemicolon, lastComma);
            }
            
            // If still no good boundary, split at last space
            if (splitIndex === -1 || splitIndex < maxSize * 0.3) {
                splitIndex = searchArea.lastIndexOf(' ');
            }
            
            // Last resort: hard split
            if (splitIndex === -1) {
                splitIndex = maxSize - 1;
            }
            
            chunks.push(remaining.substring(0, splitIndex + 1).trim());
            remaining = remaining.substring(splitIndex + 1).trim();
        }
        
        return chunks;
    }
    
    // Translate a single chunk
    async function translateChunk(text, sourceLang, targetLang) {
        try {
            const response = await fetch(
                `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`
            );
            const data = await response.json();
            
            if (data.responseStatus == 200 && data.responseData && data.responseData.translatedText) {
                const translated = data.responseData.translatedText;
                if (!translated.includes('INVALID') && !translated.includes('QUERY LENGTH LIMIT')) {
                    return translated;
                }
            }
            return null;
        } catch (error) {
            console.error('Chunk translation error:', error);
            return null;
        }
    }
    
    async function translateText(text, targetLang = 'en') {
        if (!text || text.trim().length === 0) {
            return { translatedText: text, detectedLanguage: 'unknown' };
        }
        
        // Detect source language
        const sourceLang = detectLanguage(text);
        
        // If already in English, return as-is
        if (sourceLang === 'en') {
            return { translatedText: text, detectedLanguage: 'en', alreadyEnglish: true };
        }
        
        try {
            // Split long text into chunks
            const chunks = splitIntoChunks(text, MAX_CHUNK_SIZE);
            const translatedChunks = [];
            
            console.log(`Translating ${chunks.length} chunk(s) from ${sourceLang} to ${targetLang}`);
            
            for (let i = 0; i < chunks.length; i++) {
                const chunk = chunks[i];
                const translated = await translateChunk(chunk, sourceLang, targetLang);
                
                if (translated) {
                    translatedChunks.push(translated);
                } else {
                    // If translation fails, use original chunk
                    translatedChunks.push(chunk);
                }
                
                // Delay between chunks to avoid rate limiting
                if (i < chunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 400));
                }
            }
            
            return {
                translatedText: translatedChunks.join(' '),
                detectedLanguage: sourceLang
            };
            
        } catch (error) {
            console.error('Translation error:', error);
            return { translatedText: text, detectedLanguage: 'unknown', failed: true };
        }
    }
    
    async function translateAll() {
        const btn = document.querySelector('.btn-translate-all');
        const btnText = btn.querySelector('.translate-text');
        const btnIcon = btn.querySelector('i');
        const isTranslated = btn.dataset.translated === 'true';
        
        const titleEl = document.querySelector('.location-title');
        const descEl = document.querySelector('.location-description');
        const commentEls = document.querySelectorAll('.comment-text');
        
        // If already translated, toggle back to original
        if (isTranslated) {
            if (titleEl) titleEl.textContent = titleEl.dataset.original;
            if (descEl) descEl.textContent = descEl.dataset.original;
            commentEls.forEach(el => {
                el.textContent = el.dataset.original;
            });
            
            btn.dataset.translated = 'false';
            btn.classList.remove('translated');
            btnText.textContent = 'Translate to English';
            btnIcon.className = 'bi bi-translate';
            return;
        }
        
        // Show loading state
        btn.disabled = true;
        btnText.textContent = 'Translating...';
        btnIcon.className = 'spinner-border spinner-border-sm';
        
        if (titleEl) titleEl.classList.add('translating');
        if (descEl) descEl.classList.add('translating');
        commentEls.forEach(el => el.classList.add('translating'));
        
        let translatedCount = 0;
        let alreadyEnglishCount = 0;
        
        try {
            // Collect all texts to translate
            const textsToTranslate = [];
            if (titleEl) textsToTranslate.push({ el: titleEl, text: titleEl.dataset.original });
            if (descEl) textsToTranslate.push({ el: descEl, text: descEl.dataset.original });
            commentEls.forEach(el => {
                textsToTranslate.push({ el, text: el.dataset.original });
            });
            
            // Translate with delay between requests
            for (let i = 0; i < textsToTranslate.length; i++) {
                const item = textsToTranslate[i];
                const result = await translateText(item.text);
                
                if (result) {
                    if (result.alreadyEnglish) {
                        alreadyEnglishCount++;
                    } else if (!result.failed) {
                        item.el.textContent = result.translatedText;
                        translatedCount++;
                    }
                }
                
                // Delay to avoid rate limiting
                if (i < textsToTranslate.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            // Update button state
            btn.dataset.translated = 'true';
            btn.classList.add('translated');
            
            if (alreadyEnglishCount === textsToTranslate.length) {
                btnText.textContent = 'Already in English';
            } else {
                btnText.textContent = 'Show Original';
            }
            btnIcon.className = 'bi bi-arrow-counterclockwise';
            
        } catch (error) {
            console.error('Translation failed:', error);
            btnText.textContent = 'Failed - Retry';
            btnIcon.className = 'bi bi-exclamation-triangle';
        } finally {
            btn.disabled = false;
            if (titleEl) titleEl.classList.remove('translating');
            if (descEl) descEl.classList.remove('translating');
            commentEls.forEach(el => el.classList.remove('translating'));
        }
    }
</script>

<%- include("../partials/footer"); %>
